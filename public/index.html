<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±€åŸŸç½‘æ–‡ä»¶å¿«ä¼ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-slate-100 min-h-screen p-6">

    <div class="max-w-3xl mx-auto space-y-6">
        
        <header class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm">
            <div>
                <h1 class="text-xl font-bold text-slate-800">ğŸ“‚ å±€åŸŸç½‘æ–‡ä»¶å…±äº«</h1>
                <p id="server-ip" class="text-xs text-slate-400">æ­£åœ¨è·å–IP...</p>
            </div>
            <button onclick="toggleQR()" class="flex items-center gap-2 text-sm bg-blue-50 text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-100 transition">
                <span>ğŸ“± æ‰‹æœºè¿æ¥</span>
            </button>
        </header>

        <div id="qr-container" class="hidden bg-white p-6 rounded-xl shadow-sm text-center animate-fade-in">
            <p class="text-sm text-slate-500 mb-4">æ‰‹æœºæ‰«æä¸‹æ–¹äºŒç»´ç ï¼Œæ— éœ€ä¸‹è½½ App å³å¯äº’ä¼ æ–‡ä»¶</p>
            <div id="qrcode" class="flex justify-center"></div>
        </div>

        <div id="drop-zone" class="bg-white border-2 border-dashed border-blue-300 rounded-xl p-10 text-center cursor-pointer hover:bg-blue-50 transition relative">
            <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
            <div class="space-y-2 pointer-events-none">
                <div class="text-4xl">â˜ï¸</div>
                <p class="text-slate-600 font-medium">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ </p>
            </div>
        </div>

        <div id="progress-container" class="hidden bg-white p-4 rounded-xl shadow-sm space-y-2">
            <div class="flex justify-between text-sm">
                <span id="upload-status">æ­£åœ¨ä¸Šä¼ ...</span>
                <span id="upload-percent">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                <h2 class="font-bold text-slate-700">å·²å…±äº«æ–‡ä»¶</h2>
                <button onclick="loadFiles()" class="text-blue-600 text-sm hover:underline">åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <ul id="file-list" class="divide-y divide-slate-100"></ul>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('file-input');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const uploadPercent = document.getElementById('upload-percent');

        // 1. ç›‘å¬æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) uploadFile(file);
        });

        // 2. ä¸Šä¼ æ ¸å¿ƒé€»è¾‘ (ä½¿ç”¨ XMLHttpRequest ä»¥è·å–è¿›åº¦)
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            // æ˜¾ç¤ºè¿›åº¦æ¡
            progressContainer.classList.remove('hidden');
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);

            // ç›‘å¬è¿›åº¦
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percent + '%';
                    uploadPercent.innerText = percent + '%';
                }
            };

            // ä¸Šä¼ å®Œæˆ
            xhr.onload = () => {
                if (xhr.status === 200) {
                    alert('âœ… ä¸Šä¼ æˆåŠŸ');
                    loadFiles(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('âŒ ä¸Šä¼ å¤±è´¥');
                }
                // é‡ç½®è¿›åº¦æ¡
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                }, 1000);
            };

            xhr.send(formData);
        }

        // 3. åŠ è½½æ–‡ä»¶åˆ—è¡¨
        function loadFiles() {
            fetch('/api/files')
                .then(res => res.json())
                .then(files => {
                    const list = document.getElementById('file-list');
                    list.innerHTML = ''; // æ¸…ç©º

                    if (files.length === 0) {
                        list.innerHTML = '<li class="p-4 text-center text-slate-400 text-sm">æš‚æ— æ–‡ä»¶...</li>';
                        return;
                    }

                    files.forEach(file => {
                        const li = document.createElement('li');
                        li.className = "p-4 flex items-center justify-between hover:bg-slate-50 transition";
                        li.innerHTML = `
                            <div class="flex items-center gap-3 overflow-hidden">
                                <span class="text-2xl">ğŸ“„</span>
                                <div class="min-w-0">
                                    <p class="font-medium text-slate-800 truncate">${file.name}</p>
                                    <p class="text-xs text-slate-400">${file.size} Â· ${file.time}</p>
                                </div>
                            </div>
                            <a href="/files/${file.name}" download class="px-4 py-2 bg-blue-100 text-blue-600 rounded-lg text-sm hover:bg-blue-200 shrink-0">ä¸‹è½½</a>
                        `;
                        list.appendChild(li);
                    });
                });
        }

        // é¡µé¢åŠ è½½æ—¶è·å–ä¸€æ¬¡åˆ—è¡¨
        loadFiles();
const qrContainer = document.getElementById('qr-container');
        let qrGenerated = false;

        // 4. è·å–æœåŠ¡å™¨ IP å¹¶ç”ŸæˆäºŒç»´ç 
        function initQR() {
            fetch('/api/address')
                .then(res => res.json())
                .then(data => {
                    // æ˜¾ç¤ºæ–‡å­—ç‰ˆ IP
                    document.getElementById('server-ip').innerText = `æœ¬æœº IP: ${data.ip} (ç«¯å£ 3001)`;
                    
                    // ç”ŸæˆäºŒç»´ç å›¾ç‰‡
                    if (!qrGenerated) {
                        new QRCode(document.getElementById("qrcode"), {
                            text: data.url,
                            width: 180,
                            height: 180,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                        qrGenerated = true;
                    }
                });
        }

        // 5. åˆ‡æ¢äºŒç»´ç æ˜¾ç¤º/éšè—
        function toggleQR() {
            qrContainer.classList.toggle('hidden');
        }

        // é¡µé¢åŠ è½½æ—¶å…ˆå»è·å–ä¸€ä¸‹ IP ä¿¡æ¯ï¼ˆä½†ä¸ä¸€å®šé©¬ä¸Šæ˜¾ç¤ºäºŒç»´ç æ¡†ï¼‰
        initQR();

    </script>
</body>
</html>